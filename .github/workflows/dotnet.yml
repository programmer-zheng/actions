# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
# 手动运行
  workflow_dispatch:
    inputs:
      version:
        description: '版本号'
        required: true
        

  # push:
  #   branches: [ "master" ]
  # pull_request:
  #   branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
#      - name: 设置.NET环境
#        uses: actions/setup-dotnet@v3
#        with:
#          dotnet-version: 6.0.x
#      - name: 还原Nuget包
#        run: dotnet restore
#      - name: 编译
#        run: dotnet build --no-restore
#      - name: 测试
#        run: dotnet test --no-build --verbosity normal
#      - name: 查看当前目录
#        run: echo $(pwd)
#      - name: 查看当前目录列表
#        run: echo $(ls -ll)
#      - name: 编译docker镜像
#        run: docker build . --file DotnetCoreMvcTestGithubActions/Dockerfile --tag my-image-name:$(date +%s)
#      - name: 保存docker镜像
#        run: docker save -o /my-image-name-$(date +%s).tar my-image-name:$(date +%s) 
      - name: 编译docker镜像
        run: docker build . --file DotnetCoreMvcTestGithubActions/Dockerfile --tag ${{secrets.DOCKER_HUB_USERNAME}}/my-image-name:${{github.event.inputs.version}}
      - name: 登录Docker Hub
        run: docker login -u ${{secrets.DOCKER_HUB_USERNAME}} -p ${{secrets.DOCKER_HUB_PASSWORD}}
      - name: 推送镜像
        run: docker push ${{secrets.DOCKER_HUB_USERNAME}}/my-image-name:${{github.event.inputs.version}}
      - name: 退出登录
        run: docker logout
      - name: 保存docker镜像
        run: docker save -o my-image-name-${{ github.event.inputs.version }}.tar my-image-name:${{ github.event.inputs.version }}
      - name: Release
        uses: actions/create-release@latest
        env: 
          GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version}}
          release_name: v${{ github.event.inputs.version}}
          body_path: /home/runner/work/actions/actions/my-image-name-${{ github.event.inputs.version }}.tar
          draft: false
          prerelease: false
